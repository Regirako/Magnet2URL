<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Redirecionando Magnet</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        text-align: center;
        padding: 2em;
        background-color: #f5f5f5;
        position: relative;
        margin: 0;
      }

      h1, h2, p {
        color: #333;
      }

      button {
        padding: 12px 24px;
        font-size: 1em;
        border: none;
        background-color: #2e7d32;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      button:hover {
        background-color: #1b5e20;
        transform: scale(1.05);
      }

      .music-btn {
        background-color: #003366;
      }

      .music-btn:hover {
        background-color: #002244;
      }

      .footer-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40px;
        background: rgba(51, 51, 51, 0.2);
        overflow: hidden;
        display: flex;
        align-items: center;
        z-index: 10;
      }

      .footer-banner span {
        white-space: nowrap;
        display: inline-block;
        padding-left: 100%;
        animation: slide-left 50s linear infinite;
        color: #333;
        font-size: 14px;
        font-weight: bold;
      }

      @keyframes slide-left {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
      }

      .regirako-img {
        position: fixed;
        right: 20px;
        bottom: 60px;
        height: 600px;
        opacity: 0.5;
        z-index: 5;
        pointer-events: none;
        transform-origin: center center;
        transition: transform 0.1s linear;
      }
    </style>
  </head>
  <body>
    <h1>Redirecionando para o cliente de torrent...</h1>

    <script>
      let magnetLink = "";
      let audio;
      let regirakoImg;

      function redirecionar() {
        if (magnetLink.startsWith("magnet:?")) {
          window.location.href = magnetLink;
        }
      }

      function toggleMusic() {
        if (audio.paused) {
          audio.play();
        } else {
          audio.pause();
        }
      }

      function iniciarDancaSincronizada(audioElement) {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const source = context.createMediaElementSource(audioElement);
        const analyser = context.createAnalyser();
        analyser.fftSize = 256;

        source.connect(analyser);
        analyser.connect(context.destination);

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function animate() {
          analyser.getByteFrequencyData(dataArray);

          const volume = dataArray.reduce((acc, val) => acc + val, 0) / bufferLength;

          // ↓ Ajuste para limitar o crescimento
          const baseScale = 1.0;
          const maxScale = 1.06; // antes era até 1.3, agora suavizado
          const dynamicScale = baseScale + Math.min(volume / 300, maxScale - baseScale);

          if (regirakoImg) {
            regirakoImg.style.transform = `scale(${dynamicScale})`;
          }

          requestAnimationFrame(animate);
        }

        animate();
      }

      window.onload = () => {
        magnetLink = decodeURIComponent(window.location.hash.substring(1));

        // Adiciona a imagem dançante em todas as páginas
        regirakoImg = document.createElement("img");
        regirakoImg.src = "assets/regirako.png";
        regirakoImg.alt = "Regirako";
        regirakoImg.className = "regirako-img";
        document.body.appendChild(regirakoImg);

        if (magnetLink.startsWith("magnet:?")) {
          window.location.href = magnetLink;

          setTimeout(() => {
            document.body.innerHTML = `
              <h2>Você não foi redirecionado automaticamente?</h2>
              <p>
                Isso pode ocorrer se você não tiver um programa para abrir <strong>links Magnet</strong> instalado.<br><br>
                <strong>1.</strong> Baixe e instale o <a href='https://www.fosshub.com/qBittorrent.html' target='_blank'><strong>qBittorrent Windows 64 bits</strong></a>.<br>
                <strong>2.</strong> Durante a instalação, permita que ele seja o programa padrão para arquivos <strong>.torrent</strong> e <strong>links Magnet</strong>.<br>
                <strong>3.</strong> Volte nesta página e clique no botão abaixo:
              </p>
              <button onclick="redirecionar()">Clique aqui para tentar novamente</button><br>
              <button class="music-btn" onclick="toggleMusic()">Music ON/OFF</button>
              <div class="footer-banner">
                <span><strong>Leia o que está escrito na página, ela é um tutorial de como utilizar o redirecionamento automático para o download no aplicativo de gerenciamento de torrents.</strong></span>
              </div>
              <audio id="bg-audio" autoplay loop>
                <source src="assets/tokyo.mp3" type="audio/mpeg">
                Seu navegador não suporta o elemento de áudio.
              </audio>
            `;

            document.body.appendChild(regirakoImg);
            audio = document.getElementById("bg-audio");

            audio.onplay = () => {
              iniciarDancaSincronizada(audio);
            };
          }, 3000);
        } else {
          document.body.innerHTML = "<h2>Magnet link inválido ou ausente.</h2>";
        }
      };
    </script>
  </body>
</html>
