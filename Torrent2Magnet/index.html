<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Extrator de info_hash de Torrent</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    input[type="file"] {
      margin: 20px 0;
    }
    #output {
      margin-top: 20px;
      text-align: left;
      display: inline-block;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Extrator de info_hash de Torrent</h1>
  <p>Selecione um arquivo <code>.torrent</code> para extrair o <code>info_hash</code> e o nome:</p>
  <input type="file" id="torrentFile" accept=".torrent">
  <div id="output"></div>
  <script>
    // Biblioteca bencode.js incorporada
    const bencode = {
      decode: (data) => {
        const textDecoder = new TextDecoder();
        let offset = 0;

        function next() {
          return String.fromCharCode(data[offset++]);
        }

        function peek() {
          return String.fromCharCode(data[offset]);
        }

        function decodeItem() {
          const char = next();
          if (char === 'i') {
            let end = data.indexOf(0x65, offset); // 'e'
            const number = parseInt(textDecoder.decode(data.slice(offset, end)));
            offset = end + 1;
            return number;
          } else if (char === 'l') {
            const list = [];
            while (peek() !== 'e') list.push(decodeItem());
            offset++; return list;
          } else if (char === 'd') {
            const dict = {};
            while (peek() !== 'e') {
              const key = decodeItem();
              dict[key] = decodeItem();
            }
            offset++; return dict;
          } else if (/\d/.test(char)) {
            let lenStr = char;
            while (peek() !== ':') lenStr += next();
            offset++; // skip ':'
            const len = parseInt(lenStr);
            const value = data.slice(offset, offset + len);
            offset += len;
            return value;
          }
          throw new Error("Formato bencode inválido");
        }

        return decodeItem();
      },
      encode: (obj) => {
        function encodeItem(item) {
          if (typeof item === 'number') {
            return `i${item}e`;
          } else if (item instanceof Uint8Array) {
            return `${item.length}:${new TextDecoder().decode(item)}`;
          } else if (typeof item === 'string') {
            return `${item.length}:${item}`;
          } else if (Array.isArray(item)) {
            return `l${item.map(encodeItem).join('')}e`;
          } else if (typeof item === 'object') {
            const keys = Object.keys(item).sort();
            return `d${keys.map(k => encodeItem(k) + encodeItem(item[k])).join('')}e`;
          }
        }

        return new TextEncoder().encode(encodeItem(obj));
      }
    };

    document.getElementById('torrentFile').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const arrayBuffer = e.target.result;
          const uint8Array = new Uint8Array(arrayBuffer);
          const torrent = bencode.decode(uint8Array);

          if (!torrent.info) {
            throw new Error("Dicionário 'info' não encontrado no arquivo .torrent.");
          }

          const info = torrent.info;
          const name = info.name ? new TextDecoder().decode(info.name) : "Nome não disponível";
          const encodedInfo = bencode.encode(info);

          crypto.subtle.digest("SHA-1", encodedInfo).then(hashBuffer => {
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const infoHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            const magnetLink = `magnet:?xt=urn:btih:${infoHash}&dn=${encodeURIComponent(name)}`;

            document.getElementById('output').innerHTML = `
              <p><strong>Nome:</strong> ${name}</p>
              <p><strong>info_hash:</strong> ${infoHash}</p>
              <p><strong>Magnet Link:</strong> <a href="${magnetLink}" target="_blank">${magnetLink}</a></p>
            `;
          }).catch(err => {
            throw new Error("Erro ao calcular o SHA-1: " + err.message);
          });

        } catch (err) {
          document.getElementById('output').innerHTML = `<p class="error">Erro: ${err.message}</p>`;
        }
      };

      reader.onerror = function() {
        document.getElementById('output').innerHTML = `<p class="error">Erro ao ler o arquivo.</p>`;
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
